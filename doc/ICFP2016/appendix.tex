\appendix
\section{Transforming recursive types}
\label{sec:transf-recurs-types}


\begin{figure}[t]
  \begin{align*}
    a & ::= \omega && \text{infinite words, only} \\
    & \mid \infty && \text{finite and infinite words} \\
    & \omega \sqsubset \infty \\
    n & ::= 0 \mid 1 && \text{minimum length of trace} \\
    A & ::= \cdot \mid A, x:a && \text{environments} \\
    C & ::= \cdot \mid C, (x,n) && \text{depth of guardedness}
  \end{align*}
  \begin{gather*}
    \frac{}{A \vdash \skipk : \infty; 0; C }
    \quad
    \frac{}{A \vdash {!B} : \infty; 1; C}
    \quad
    \frac{}{A \vdash {?B} : \infty; 1; C}
    \\
    \frac{A \vdash S_1 : a_1;n_1;C_1 \quad A \vdash S_2 : a_2;n_2;C_2}{
      A \vdash (S_1;S_2) : a_1 \sqcap a_2;\seq(a_1)(a_2)}
    \\
    \frac{(\forall i\in I)~A \vdash S_i : a_i; n_i ; C_i}{
      A \vdash \star\{l_i\colon S_i\}_{i\in I} :
      \bigsqcup_i a_i; 
      1; \bigsqcap_i C_i \uparrow 1}
%     \quad
%     \frac{(\forall i\in I)~A \vdash S_i : a_i}{
%       A \vdash \&\{l_i\colon S_i\}_{i\in I} :
%       \bigsqcup_i a_i}
    \\
    \frac{}{A, x : a \vdash x : 1 ; C,(x,0)} \quad
    \frac{A, x : a \vdash S : a; n ; C, (x,1) }{A \vdash \mu x.S : a; n; C}
  \end{gather*}
  \begin{align*}
    \seq (n_1; C_1) (n_2; C_2) & = (n_1 + n_2 ; C_1 \sqcap C_2 \uparrow n_1
    ) \\
    (x, i) \uparrow n &= (x, i + n)
  \end{align*}
  \caption{Inference for infiniteness (and contractivity)}
  \label{fig:inference-infiniteness}
\end{figure}
Figure~\ref{fig:inference-infiniteness} contains an inference system for detecting finite words. It
classifies session types $S$ according to their trace languages. The intent is as follows: If all traces of $S$ are infinite
words in $\Sigma^\omega$, then $A \vdash S : \omega; n; C$ is derivable. If $S$ may admit a finite trace
in $\Sigma^\infty$, then $A \vdash S : \infty; n; C$ is derivable. The result $n$ indicates the
minimum length of a trace generated/accepted by $S$. The $C$ contains pairs of the form $(x,n)$
which indicates a lower bound on the trace produced before $x$ is mentioned recursively. The
formation rule for $\mu x.S$ requires $(x,1)$ which is equivalent to contractivity in $x$.


We write $A \models \rho$ if $\dom (A) = \dom (\rho)$ and for all $x :a \in A$, let $R_x = \rho (x)$
where $R_x \ne \emptyset$, $R_x \subseteq \Sigma^a$, and $\min\{ |t| \mid t\in R_x \}\ge1$.

\begin{lemma}
  If $A \vdash S : a; n; C$ and $A \models \rho$, then $T = \TR (S) \rho \subseteq \Sigma^a$ and
  $\min\{ |t| \mid t \in T\} \ge n$.
\end{lemma}
\begin{proof}
  Induction on $S$. Relies on $\TR (S) \rho \ne \emptyset$, for all $S$.

  \textbf{Case }$\skipk$, $!B$, $?B$: Immediate.

  \textbf{Case }$(S_1;S_2)$: By inversion, $A \vdash S_1: a_1;n_1;C_1$, $A\vdash S_2:a_2;n_2;C_2$, and $a = a_1
  \sqcap a_2$, $(n;C) = \seq (n_1;C_1) (n_2;C_2)$.
  If $a=\omega$, then there are two non-exclusive cases $a_1=\omega$ or $a_2 = \omega$.

  \textbf{Subcase }$a_1 = \omega$: By induction $\TR (S_1) \rho \subseteq \Sigma^\omega$, hence $\TR
  (S_1;S_2)\rho = \TR (S_1)\rho \cdot \TR (S_2)\rho = \TR (S_1)\rho \subseteq \Sigma^\omega$ because $\TR (S_2)\rho$
  is not empty. The condition on $n$ holds trivially because there are no finite traces.

  \textbf{Subcase }$a_1 = \infty$ and $a_2 = \omega$: By induction $\TR (S_2) \rho \subseteq \Sigma^\omega$, hence  $\TR
  (S_1;S_2)\rho = \TR (S_1)\rho \cdot \TR (S_2)\rho \subseteq \Sigma^\omega$ because $\TR (S_1)\rho$
  is not empty. Again, the condition on $n$ holds trivially.

  \textbf{Subcase }$a_1 = a_2 = \omega$: The condition on $n$ holds because $|v\cdot w| = |v|+|w|$.

  \textbf{Case }$\star\{l_i\colon S_i\}$: By inversion, $A \vdash S_i : a_i; n_i; C_i$ and $a = \bigsqcup_i
  a_i$, $n=1$, and $C = \bigsqcap_i C_i \uparrow 1$.
  If $a=\omega$, then $a_i = \omega$, for all $i$. Hence, by induction $\TR (\oplus\{l_i\colon
  S_i\})\rho = \bigcup_i \{L_i\}\cdot\TR (S_i)\rho \subseteq \Sigma^\omega$. The condition on $n$ is
  trivial because each trace has length $\ge1$.

  \textbf{Case }$x$: Immediate by assumption $A \models \rho$.

  \textbf{Case }$\mu x.S$: By inversion, $A, x:a \vdash S:a;n;C,(x,1)$. If $a=\infty$, then any (non-empty)
  extension of $\rho$ satisfies $A, x:\infty \models \rho[x\mapsto Y]$ and the result is immediate by
  induction. 

  If $a= \omega$, then consider
  \begin{align*}
    \TR (\mu x.S)\rho & = \GFP\, \lambda Y. \TR (S)\rho[x\mapsto Y] \\
    & = \TR (S)\rho[x\mapsto \GFP\, \lambda Y. \TR (S)\rho[x\mapsto Y]]
  \end{align*}

  \textbf{Subsidiary lemma:}
  Let $F (Y) = \TR (S)\rho[x\mapsto Y]$ and show that an $F$-consistent set
  cannot contain finite words.

  That is, suppose that $Y \subseteq \TR (S)\rho[x\mapsto Y]$ and there exists some $v \in Y$ of 
  length $|v| = k < \infty$. We show that there must be some $v' \in Y$ with $|v'|\le k-m$ where
  $(x,m)$ is the minimal prefix length for $x$ in $C$.

  Given that result, we argue as follows. Choose $v \in Y$ of finite minimal length $k$. From the
  inversion, we know that $m=1$. Hence, there exists some $v' \in Y$ with length $\le k-1$. From
  this contradiction it follows that $Y$ contains no finite elements.
  
  Proof by induction on the derivation of $A, x:\omega \vdash S : \omega; n; C,(x,m)$.

  \textbf{Case }$\skipk$, $!B$, $?B$: contradiction because they do not derive $\omega$.

  \textbf{Case }$(S_1;S_2)$: Observe that $v \in \TR (S_1;S_2)\rho[x\mapsto Y]$ implies that $v = v_1v_2$ with
  $v_1 \in \TR (S_1)\rho[x\mapsto Y]$ and $v_2 \in \TR (S_2)\rho[x\mapsto Y]$ where $|v_1|, |v_2| \le |v| \le k$.
  By inversion, there are two subcases:

  \textbf{Subcase }$A \vdash S_1:\omega;n_1;C_1,(x,m_1)$ where $m_1\sqsupseteq m$: By induction,
  there exists some $v'\in Y$ with $|v'| \le |v_1| - m_1 \le |v| - m$.

  \textbf{Subcase }$A \vdash S_1:\infty;n_1;C_1,(x,m_1)$ and $A \vdash S_2:\omega;n_2;C_2,(x,m_2)$
  where  $m_1\sqsupseteq m$ and  $m_2 + n_1 \sqsupseteq m$:
  By induction, there exists some $v'\in Y$ with $|v'| \le  |v_2| - m_2 \le |v| - m$ (if $n_1=0$).
  If $n_1=1$, then $|v_2| < |v|$ and we can exploit the inductive hypothesis similarly.

  \textbf{Case }$\star\{l_i\colon S_i\}$: Inversion yields $A \vdash S_i: \omega; n_i;C_i,(x,m_i)$
  and $m =1$.
  In this case, $v = L_iv_i$ (for some $i$) and $v_i \in \TR
  (S_i)\rho[x\mapsto Y]$. By induction, there exists $v'\in Y$ with $|v'|\le |v_i| - m_i \le |v_i|+1
  -1 = |v| -1$.

  \textbf{Case }$x$: In this case, $m=0$ and $v \in \rho (x) = Y$ and $|v|\le |v|-0$.

  \textbf{Case }$x'\ne x$: By inversion, it must be that $x':\omega \in A$. By $A \models \rho$, it
  must be that $v \in \rho (A) \subseteq \Sigma^\omega$, a contradiction.

  \textbf{Case }$\mu x'.S$: By the outer induction, this implies that $v\in\Sigma^\omega$, a contradiction.
\end{proof}

\begin{lemma}
  For each $S$, there is a minimal derivation, where derivations are ordered pointwise on judgments;
  judgments are ordered pointwise on environments $A$ and the $a$-component of the result.
\end{lemma}

\begin{lemma}
  If $A \vdash (S_1; S_2) : \omega; n; C$ is derivable with subderivation $A \vdash S_1 : \omega;
  n_1; C_1$, then $(S_1;S_2) \TypeEquiv S_1$.
\end{lemma}

This lemma enables the direct syntactic transformation of $\mu x.{!B};x;x$ to the equivalent $\mu
x.{!B}; x$. It even applies to proving $\mu x.{!B}; x; S \TypeEquiv \mu x.{!B}; x$ for any $S$.


\section{Obsolete type stuff}
\input{type-simulation}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "main"
%%% End:
