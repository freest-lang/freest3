\documentclass{article}

\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{color}
\usepackage{listings}
\usepackage{tikz}
\usepackage{wrapfig}
\usepackage{amsmath,amssymb,stmaryrd,amsthm}


\input{macros}

\title{Mixed choices on session types}

\begin{document}
% \maketitle
\input{processes}
\input{reduction}
\input{congruence}
\input{types}

\noindent
Subtyping:
\begin{itemize}
\item Equi-recursive
\item Up-to $V$ permutations
\item Width subtyping
\end{itemize}

\input{typing-processes}
\input{typing-choices}
\input{typing-names}
\input{duality}
\input{embeddingST}

\newpage
\noindent
Type formation:
\begin{itemize}
\item Contractive
\end{itemize}
\newpage
\section{Examples}
\lstset{language=freestMC}
\subsection{Producer--Consumer --- asymmetric version}
  \vspace{2cm}
\begin{lstlisting}
type RWC = !Msg.RWC + ?Msg.RWC + !Done.end
  
producer : int -> RWC -> ()
producer 0 c = choice c { _ = send c Done -> () }
producer n c = choice c {
    c      = send c Msg -> producer (n|-|1) c
    c, Msg = receive c  -> producer (n|-|1) c
  }

consumer : dualof RWC -> int
consumer c = choice c {
    c       = send c Msg -> consumer c
    c, Msg  = receive c  -> 1 + consumer c
    _, Done = receive c  -> 0
  }

main : int
main =
  let p, c = new RWC in 
  fork producer 1000 c;
  consumer p -- The number of messages received by this process, max 1000
\end{lstlisting}
\newpage
\subsection{Producer--Consumer --- symmetric version}
\vspace{2cm}
\begin{lstlisting}
type RWC = !Msg.RWC + ?Msg.RWC
  
-- The number of messages sent by this function out of n
readWrite : int -> int -> RWC -> int
readWrite 0 m c = fork consume c ; m
readWrite n m c = choice c {
    c      = send c Msg -> readWrite (n|-|1) (m+1) c
    c, Msg = receive    -> readWrite (n|-|1) m c
  }

-- Consume c ad eternum
consume : RWC -> () 
consume c = choice c {
    c      = send c Msg -> consume c
    c, Msg = receive    -> consume c
  }

main : int
main =
  let c1, c2 = new RWC
      msgs = 1000 in
  fork readWrite msgs 0 c1;
  readWrite msgs 0 c2
  -- This one leaves two threads running forever
  \end{lstlisting}
  \newpage
  \subsection{Random binary number generator}
  \vspace{2cm}
  \begin{lstlisting}
type RandC = !More.RandC + !Done.end
type Bits  = int

producer : Bits -> RandC -> ()
producer 0 c = choice c { _ = send c Done -> () }
producer n c = choice c { c = send c More -> producer (n|-|1) c}

-- Non determinism at message reception
consumer : int -> dualof RandC -> int
consumer n c =
  choice c {
    c, More = receive -> consumer (10*n) c
    c, More = receive -> consumer (10*n + 1) c
    _, Done = receive -> n
  }

-- Random number generator of a given number of bits
main : int
main =
  let p, c = new RandC in
  fork producer 128 p;
  consumer 0 c
  \end{lstlisting}
\end{document}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: t
%%% End:
