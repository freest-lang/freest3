\section{Introduction}
\label{sec:introduction}

Session types enhance the expressivity of traditional types for
programming languages by enabling describing structured communication
on heterogeneously typed
channels~\cite{DBLP:conf/concur/Honda93,DBLP:conf/esop/HondaVK98,DBLP:conf/parle/TakeuchiHK94}.
%
Traditional session types are \emph{regular} in the sense that the
sequences of communication actions admitted by a type are in the union
of a regular language (for finite executions) and an $\omega$-regular
language (for infinite executions).
%
Introduced by Thiemann and Vasconcelos, context-free session types
liberate traditional session types from the shackles of tail
recursion, allowing for example, the safe serialization of arbitrary
recursive datatypes~\cite{thiemann2016context}.

If the algorithmic aspects of type equivalence for regular session
types are well known (Gay and Hole authored an algorithm to decide
subtyting~\cite{DBLP:journals/acta/GayH05}, from which type
equivalence can be derived), the same does not apply to context-free
session types.
%
In the aforementioned work, Thiemann and Vasconcelos showed that the
equivalence of context-free session types is decidable, by reducing
the problem to the verification of bisimulation for Basic Process
Algebra (BPA) which, in turn, was proved decidable by Christensen,
H{\"{u}}ttel, and Stirling~\cite{DBLP:journals/iandc/ChristensenHS95}.
%
Even if the equivalence problem for context-free session types is
known to be decidable, the only implementation of context-free session
types we are aware of is that of
Padovani~\cite{DBLP:conf/esop/Padovani17}, included in a programming
language that requires a structural alignment between code and types
(enforced by an explicit resumption process operator that explicitly
breaks a type $S;T$), thus sidestepping checking type equivalence.

After the breakthrough by Christensen, H\"uttel, and Stirling--- a
result that provides no immediate practical algorithm---the problem of
deciding the equivalence of BPA terms has been addressed by several
researchers~\cite{DBLP:conf/mfcs/BurkartCS95,DBLP:journals/iandc/ChristensenHS95,janvcar1999techniques},
but again, no actual practical algorithm can be readily extracted from
these papers.
%
Furthermore, context-free session types are not necessarily normed,
which precludes using the original result by Baeten, Bergstra, and
Klop~\cite{baeten1993decidability}, as well as improvements by Hirshfeld,
Janc\v ar, and
Moller~\cite{DBLP:journals/tcs/HirshfeldJM96,DBLP:conf/concur/HirshfeldM94}.

In its turn, the decidability of deterministic pushdown automata 
has also been a subject of much 
study~\cite{janvcar2008selected,senizergues1997equivalence,stirling2001decidability}. 
Several techniques have been proposed to solve the problem, 
however no immediate practical algorithm had been proposed until
Henry and S{\'e}nizergues provide an implementation of a correct algorithm 
for this problem~\cite{henry2013lalblc}. Its poor performance
precludes its incorporation in a compiler.

Our algorithm to decide the equivalence of context-free session types
can also be seen as an algorithm to decide the equivalence of simple
grammars. It follows three distinct stages.
%
The \emph{first stage} builds a context-free grammar in Greibach
Normal Formal (GNF)---in fact a simple grammar---from a context-free
session type in a way that bisimulation is preserved.  A basic result
from Baeten, Bergstra, and Klop states that any guarded BPA system can
be transformed in Greibach Normal Formal (GNF) while preserving
bisimulation equivalence, but unfortunately no procedure is
presented~\cite{baeten1993decidability}.
%
The \emph{second stage} prunes the grammar by removing unreachable
symbols in unnormed sequences of non-terminal symbols. This stage
builds on the result of Christensen, H\"uttel, and 
Stirling~\cite{DBLP:journals/iandc/ChristensenHS95}.
%
The \emph{third stage} constructs an expansion tree, by alternating
between expansion and simplification steps. 
This last stage uses ideas on the expansion operations proposed by
Janc\v ar, Moller, and
Hirshfeld~\cite{hirshfeld1996bisimulation,janvcar1999techniques}, 
and ideas on the simplification rules proposed by
Caucal, Christensen, H\"uttel, Stirling, Janc\v ar, and Moller
~\cite{caucal1986decidabilite,
  DBLP:journals/iandc/ChristensenHS95,janvcar1999techniques}.
The finite representation of
bisimulations of \BPA\ transition graphs presented
in~\cite{caucal1986decidabilite,
  DBLP:journals/iandc/ChristensenHS95}
is paramount for our results of soundness and
completeness. The branching nature of the expansion tree confers an
exponential complexity to the algorithm, however we propose heuristics
that allow constructing the relation in a reasonable time.

% Contributions
We present an algorithm to decide the equivalence of context-free
session types, practical to the point that it may be readily included
in any compiler, an exercise that we conducted in
parallel~\cite{freeST}.
%
The main contributions of this work are:
%
\begin{itemize}
\item The proposal and implementation of an algorithm to decide type
  equivalence of context-free session types and simple grammars (in
  300 lines of Haskell code),
\item A proof of its soundness and completeness against the
  declarative definition,
\item The exploration of several optimizations that cut the running
  time in 12,000,000\%.
%\item validation of the algorithm on several meaningful examples.
\end{itemize}

% Outline

The rest of the paper is organized as follows: context-free session
types in Section~\ref{sec:contextfreesession}, the algorithm in
Section~\ref{sec:algorithm}, the main results in
Section~\ref{sec:soundness}, optimizations in
Section~\ref{sec:optimisations}, evaluation in
Section~\ref{sec:evaluation}, and conclusions in
Section~\ref{sec:conclusion}.

% Thiemann and
% Vasconcelos~\cite{thiemann2016context} proposed {\it context-free
%   session types} as an extension of session types by allowing nested
% protocols that are not restricted to tail recursion. Context-free
% session types capture the type-safe serialization of recursive
% datatypes and enable the type-safe implementation of remote operations
% on recursive datatypes.

% Inspired by the context-free session types' framework, Almeida and
% Vasconcelos~\cite{bernardo} proposed a functional programming language
% equipped with context-free session types.  Such a programming language
% is highly dependent on an algorithm to decide type equivalence. We
% have developed and implemented an algorithm to decide type
% equivalence. Our work capitalizes on the metatheory of context-free
% session types proposed by Thiemann and
% Vasconcelos~\cite{thiemann2016context}, where type equivalence was
% proved to be decidable. Although the decidability of equivalence on
% context-free session types has been addressed in the
% literature~\cite{DBLP:journals/iandc/ChristensenHS95,janvcar1999techniques,thiemann2016context},
% to the best of our knowledge, no algorithm was ever implemented.
% % and a possible implementation was not obvious.

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "main"
%%% End:
