\begin{lstlisting}[
  caption={Haskell code for stage 1: the conversion of types into grammars},
  label={lst:toGrammar},
  captionpos=b]
type Transitions = Map.Map LTSLabel [TypeVar]
type Productions = Map.Map TypeVar Transitions
type Visited = Set.Set TypeVar
type TransState = State (Productions, Int)

toGrammar :: Type -> TransState [TypeVar]
toGrammar Skip =
  return []
toGrammar (Message p b) = do
  y <- freshVar
  addProduction y (MessageLabel p b) []
  return [y]
toGrammar (Choice c m) = do
  y <- freshVar
  mapM_ (assocsToGrm y c) (Map.assocs m)
  return [y]
toGrammar (Semi t u) = do
  xs <- toGrammar t
  ys <- toGrammar u
  return (xs ++ ys)
toGrammar (Rec x t) = do
  zs <- toGrammar t
  if null zs
    then return []
    else do
      m <- getTransitions (head zs)
      addProductions x (Map.map (++ tail zs) m)
      return [x]
toGrammar (Var x) =
  return [x]

assocsToGrm :: TypeVar -> ChoiceView -> (TypeLabel,Type) -> TransState ()
assocsToGrm y c (l, t) = do
  xs <- toGrammar t
  addProduction y (ChoiceLabel c l) xs
\end{lstlisting}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "main"
%%% End:
