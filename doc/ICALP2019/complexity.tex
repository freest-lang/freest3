\section{Complexity Analysis}
\label{sec:complexity}

\todo{AM}{complexity analysis for toGrammar (and prune)}

To carry out an analysis on the complexity of the algorithm, 
consider $X_S$ and $X_T$ the initial non-terminal symbols for 
$S$ and $T$, let $\mathcal{P}$ denote the set of productions for 
$S$ and $T$ and also:
\begin{itemize}
	\item $S$ represent the maximum number of symbols in the RHS
	      of productions in $\mathcal{P}$;
	\item $L$ stand for the maximum number of labels within the choice 
		  operators in $\mathcal{P}$;
	\item $N_0^+$ and $N_0^-$ represent the maximum and minimum values
		  of the norms of $X_S$ and $X_T$, respectively, where we 
		  assume $|X|=\infty$ whenever $X$ is unnormed.
\end{itemize}

We start by analyzing the complexity of each simplification or expansion 
step in the expansion tree. For this, we now fix some notation, to 
refer to the number ``elements'' (read: nodes, pairs, length, etc.)
at the $i^{th}$ level of the expansion tree:
\begin{itemize}
	\item $a_i$ denotes the number of ancestors;
	\item $n_i$ denotes the number of nodes;
	\item $p_i$ refers to the maximum number of pairs in each node
				at level $i$;
	\item $s_i^+$ and $s_i^-$ denotes the maximum and minimum 
		  number of symbols in the sequences composing each pair;
	\item $\rho_i^+$ and $\rho_i^-$ denotes the maximum and minimum
		  norms occurring among all pairs.
\end{itemize}

Observe that in the root we have: $a_0=0$, $n_0=1$, $p_0=1$,
$s_0^+=s_0^-=1$, $\rho_0^+=N_0^+$, $\rho_0^-=N_0^-$. And now, let us proceed
with this analysis by exploring the structure of the expansion tree. Assume 
that at the $i^{th}$ level we succeed on an expansion step to
level $i+1$;
we would have: $a_{i+1}=a_i+n_i$, $n_{i+1}\leq n_i$, 
$p_{i+1}\leq p_i\cdot L$,
$s_{i+1}^+\leq s_i^++S$, $s_{i+1}^-\leq s_i^-+S$, $\rho_{i+1}^+=\rho_i^+-1$ 
if $\rho_i^+$ is finite and  $\rho_{i+1}^+ = \infty$ otherwise.

Similarly, notice that when applying \lstinline{bpa2} from level $i$
to level $i+1$, we have: $a_{i+1}=a_i$, $n_{i+1} \leq n_i\cdot p_i + n_i$,
$p_{i+1} \leq p_i+1$, $s_{i+1}^+=s_i^+$, $s_{i+1}^-=1$, 
$\rho_{i+1}^\pm\leq \rho_i^\pm$ if $\rho_i^\pm$ are finite. 
Finally, when applying \lstinline{bpa1} from level $i$
to level $i+1$, we have: $a_{i+1}=a_i$, $n_{i+1} \leq p_i \cdot a_i+n_i$,
$p_{i+1}\leq p_i+1$, $s_{i+1}^- \leq s_i^- - 1$.
Before proceeding, just notice that \lstinline{reflex} and 
\lstinline{congruence} do not affect the complexity analysis, hence 
we will omit them from this analysis.

So far, we have made a simple analysis on the complexity of each 
simplification and expansion operations, and we conclude that
these operations promote a polynomial increase on the size of the
expansion tree. 
However, the proposed algorithm, alternates between expansion 
operations and iterations of the simplification phase until 
reaching a fixed point. We will carry out this analysis by 
splitting into two cases: the case in which all symbols 
in the productions are normed, and the case where some
of them are unnormed.\smallskip

\begin{theorem}
	The finite branch as polynomial length on the size of the root
	$(X_S,X_T)$.
\end{theorem}

\noindent\textbf{Case 1:} In the simplest case where all symbols
occurring in $\mathcal{P}$ are normed, the expansion stage should 
terminate in polynomial time because at each iteration step, from level 
$i$ to level $i+1$, we have $\rho_{i+1}^+ < \rho_i^+$, 
hence the expansion procedure should terminate in, at most, $\rho_i^+$.
On the other hand, the application of \lstinline{bpa2} 
on a given node $N$ forces a strict decrease on the minimal
norm occurring among pairs in the new sibling $N'$. 
Note that for the purpose of computing the fixed point, the
presence of nodes from level $i$ at level $i+1$ is not relevant.
For these reasons, the simplification stage iterates at most 
$(n_i\cdot p_i)+ (n_{i+1}\cdot p_{i+1}) +
\ldots + (n_{i+\rho_i^+}\cdot p_{i+\rho_i^+})$ 
times until reaching a fixed point. \smallskip

\noindent\textbf{Case 2:} In the case where there are unnormed symbols
in the productions, the expansion tree might not terminate, however
we now prove that in the case where the equivalence should be decided
positively, we reach an empty node within a polynomial number of steps.
Just note that in the case where the equivalence should be decided negatively
the branch keeping the expansion tree (free of simplifications) will
terminate in, at most, $L\cdot \sum_{k\in\Delta} k$ expansion steps, 
where $\Delta = \{|X| : X \text{ is a non-terminal symbol 
occurring in }\mathcal{P}\}.$

Let us remark that, in this second case, \lstinline{bpa1} and 
\lstinline{bpa2} terminate in polynomial time. 
To justify this, consider the following
metric on the pairs: $\mathsf{length}(\vec X, \vec Y) = 
\min \{\mathsf{length} \vec X, \mathsf{length} \vec Y\}.$ 
Consider also the following metrics on the nodes:
$\mathsf{length}(N) = \max_{(\vec X, \vec Y)\in \Gamma} 
\{\mathsf{length}(\vec X, \vec Y)\}$
where $\Gamma=\{(\vec X,\vec Y)\in N : \text{\lstinline{bpa1} or  
\lstinline{bpa2} is applicable to }(\vec X,\vec Y) \}$. 
Notice that for each node $N$, the application
of \lstinline{bpa1} and \lstinline{bpa2} can be applied at most
$|\Gamma|\cdot\mathsf{length}(N)$. Hence, the computation
of the fixed point terminates in polynomial time. 
 
When the grammar involves unnormed variables, the problem
stands on when do we reach a successful branch, and the
answer is based on the work by Christensen et 
al.~\cite{DBLP:journals/iandc/ChristensenHS95}.
For a given pair $(X_0\vec X, Y_0,\vec Y)$:
\begin{enumerate}
	\item \label{bullet:un,un}  if $X_0$ and $Y_0$ are unnormed, then 
		  $\vec X = \varepsilon$
		  and $\vec Y = \varepsilon$ and the conclusion on its equivalence
		  follows right after the next expansion operation;
	\item if $X_0$ is unnormed and $Y_0$ is normed, then $\vec X = \varepsilon$
		  and the procedure will either terminate as soon as
		  \begin{itemize}
		  	\item $Y_0\vec Y\LTSderives[\vec a] \varepsilon$, and takes 
		  		  $|Y_0\vec Y|$ expansion steps,
		  	\item $Y_0\vec Y\LTSderives[\vec a] Y_0\vec Y'$, case in which
		  		  there will be a successful branch using 
		  		  \lstinline{bpa1}~\cite{DBLP:journals/iandc/ChristensenHS95}, or
		  	\item $Y_0\vec Y$ reaches an unnormed variable 
		  		  (reduces to~\ref{bullet:un,un}.);
		  \end{itemize}
	\item if $X_0$ and $Y_0$ are normed, let 
		  $\rho^* = \min \{|X_0|, |Y_0|\}$. After $\rho^*$ expansion
		  operations, we will reach a pair $(X_0'\vec{X'}, Y_0',\vec{Y'})$
		  where $X_0$ is unnormed and $Y_0$ is (un)normed (or vice-versa)
		  and are reduced to the previous cases.
\end{enumerate}

We conclude that, in both cases, despite being (potentially) huge, the
number of steps to decide whether $S\sim T$ or not is polynomial on 
the size of the context-free session types $S$ and $T$.

We also remark that the double ended queue improves the 
performance of the algorithm by enabling the analysis of promising nodes 
in advance and, thus, we should expect that this complexity
results should be slightly improved by this feature, 
although not directly reflected in the complexity result.
We should also highlight that, in practice, the values of the 
parameters we have been handling are usually very small,
which justifies the running times we have presented in 
Section~\ref{sec:evaluation}.

We can now formulate the main complexity result:

\begin{theorem}
	The algorithm to check the equivalence of context-free 
	session types presented in Listings~\ref{lst:toGrammar},
	\ref{lst:prune}, \ref{lst:algorithm}, and improved with the
	simplification function presented in Listing~\ref{lst:enhanced}
	terminates in polynomial time.
\end{theorem}


























